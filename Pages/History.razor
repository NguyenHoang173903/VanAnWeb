@page "/history"
@layout Layout.MainLayout

<PageTitle>Lịch Sử</PageTitle>

<div class="history">
	<div class="history-toolbar">
		<div class="field">
			<label>From</label>
			<input type="date" class="input" @bind="FromDate" />
		</div>

		<div class="field">
			<label>To</label>
			<input type="date" class="input" @bind="ToDate" />
		</div>

		<div class="spacer"></div>

		<div class="field select">
			<VaSelect TItem="EventTypeOption"
					 Class="input"
					 Items="EventTypes"
					 @bind-Value="SelectedEventType"
					 GetValue="t => t.Id"
					 GetLabel="t => t.Name"
					 AriaLabel="Loại sự kiện" />
		</div>

		<div class="search">
			<span class="search-icon" aria-hidden="true">
				<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" focusable="false">
					<path d="M10 4a6 6 0 1 1 0 12 6 6 0 0 1 0-12Zm0-2a8 8 0 1 0 4.9 14.3l4.4 4.4a1 1 0 0 0 1.4-1.4l-4.4-4.4A8 8 0 0 0 10 2Z" />
				</svg>
			</span>
			<input class="input" placeholder="Tìm kiếm" @bind-value="SearchText" @bind-value:event="oninput" />
		</div>

		<button type="button" class="btn-export" @onclick="ExportExcel">
			Xuất Excel
		</button>
	</div>

	<Table MinWidth="860px" AriaLabel="Bảng lịch sử">
		<Header>
			<tr>
				<th class="col-id">ID</th>
				<th class="col-time">Thời Gian</th>
				<th class="col-device">Thiết Bị</th>
				<th class="col-account">Tài Khoản</th>
				<th class="col-type">Loại Sự Kiện</th>
				<th class="col-desc">Mô Tả</th>
			</tr>
		</Header>
		<Body>
			@if (_filteredRows.Count == 0)
			{
				<tr>
					<td class="empty" colspan="6">Không có dữ liệu</td>
				</tr>
			}
			else
			{
				@foreach (var row in PagedRows)
				{
					<tr>
						<td class="center">@row.Id</td>
						<td class="center">@row.Time</td>
						<td class="center">@row.Device</td>
						<td class="center">@row.Account</td>
						<td class="center">
							<span class="event-type @GetEventClass(row.Type)">@row.Type</span>
						</td>
						<td class="center">@row.Description</td>
					</tr>
				}
			}
		</Body>
	</Table>

	<div class="pager" aria-label="Phân trang">
		<button type="button" class="pager-btn" disabled="@(!HasPrevPage)" @onclick="GoPrev" aria-label="Trang trước">
			‹
		</button>
		<div class="pager-info">@PageNumber / @TotalPages</div>
		<button type="button" class="pager-btn" disabled="@(!HasNextPage)" @onclick="GoNext" aria-label="Trang sau">
			›
		</button>
	</div>
</div>

@code {
	private const int PageSize = 15;
	private int _pageIndex;
	private List<HistoryRow> _filteredRows = [];

	private DateTime FromDate { get; set; } = DateTime.Today;
	private DateTime ToDate { get; set; } = DateTime.Today;

	private string _selectedEventType = "all";
	private string SelectedEventType
	{
		get => _selectedEventType;
		set
		{
			if (string.Equals(_selectedEventType, value, StringComparison.Ordinal))
			{
				return;
			}

			_selectedEventType = value;
			ResetAndApplyFilters();
		}
	}

	private string _searchText = string.Empty;
	private string SearchText
	{
		get => _searchText;
		set
		{
			if (string.Equals(_searchText, value, StringComparison.Ordinal))
			{
				return;
			}

			_searchText = value;
			ResetAndApplyFilters();
		}
	}

	private List<EventTypeOption> EventTypes { get; } =
	[
		new("all", "Loại sự kiện"),
		new("login", "Đăng Nhập"),
		new("error", "Lỗi"),
		new("ok", "Hoạt Động Tốt"),
		new("warn", "Cảnh Báo")
	];

	private List<HistoryRow> Rows { get; } = BuildRows();

	protected override void OnInitialized()
	{
		ApplyFilters();
	}

	private static List<HistoryRow> BuildRows()
	{
		var baseTime = new DateTime(2026, 1, 6, 14, 20, 20);
		var devices = new[] { "", "PLC", "Bom 1", "Bom 2", "Bom 3", "Bom 4", "Bom 5", "Bom 6" };
		var types = new[] { "Đăng Nhập", "Lỗi", "Hoạt Động Tốt", "Cảnh Báo" };

		var list = new List<HistoryRow>(capacity: 30);
		for (var i = 1; i <= 30; i++)
		{
			var type = types[(i - 1) % types.Length];
			var time = baseTime.AddMinutes(i * 3);
			var timeText = time.ToString("dd/MM/yyyy HH:mm:ss");

			var device = type == "Đăng Nhập" ? "" : devices[i % devices.Length];
			var account = type == "Đăng Nhập" ? "Technical" : "Admin";

			var description = type switch
			{
				"Đăng Nhập" => $"{account} đăng nhập",
				"Lỗi" => device == "PLC" ? "PLC mất kết nối" : "Quá momen",
				"Cảnh Báo" => "Cảnh báo dòng quá tải",
				"Hoạt Động Tốt" => string.IsNullOrWhiteSpace(device) ? "Hệ thống hoạt động ổn định" : $"{device} hoạt động ổn định",
				_ => ""
			};

			list.Add(new HistoryRow(
				i.ToString("00"),
				timeText,
				device,
				account,
				type,
				description));
		}

		return list;
	}

	private IEnumerable<HistoryRow> PagedRows
		=> _filteredRows
			.Skip(_pageIndex * PageSize)
			.Take(PageSize);

	private int TotalPages
	{
		get
		{
			if (_filteredRows.Count == 0)
			{
				return 1;
			}

			return (int)Math.Ceiling(_filteredRows.Count / (double)PageSize);
		}
	}

	private int PageNumber => TotalPages == 0 ? 1 : _pageIndex + 1;
	private bool HasPrevPage => _pageIndex > 0;
	private bool HasNextPage => _filteredRows.Count > 0 && _pageIndex + 1 < TotalPages;

	private void GoPrev()
	{
		if (!HasPrevPage)
		{
			return;
		}

		_pageIndex--;
	}

	private void GoNext()
	{
		if (!HasNextPage)
		{
			return;
		}

		_pageIndex++;
	}

	private void ResetAndApplyFilters()
	{
		_pageIndex = 0;
		ApplyFilters();
	}

	private void ApplyFilters()
	{
		IEnumerable<HistoryRow> query = Rows;

		if (!string.Equals(SelectedEventType, "all", StringComparison.OrdinalIgnoreCase))
		{
			query = SelectedEventType switch
			{
				"login" => query.Where(r => r.Type == "Đăng Nhập"),
				"error" => query.Where(r => r.Type == "Lỗi"),
				"ok" => query.Where(r => r.Type == "Hoạt Động Tốt"),
				"warn" => query.Where(r => r.Type == "Cảnh Báo"),
				_ => query
			};
		}

		if (!string.IsNullOrWhiteSpace(SearchText))
		{
			var s = SearchText.Trim();
			query = query.Where(r =>
				r.Id.Contains(s, StringComparison.OrdinalIgnoreCase) ||
				r.Time.Contains(s, StringComparison.OrdinalIgnoreCase) ||
				r.Device.Contains(s, StringComparison.OrdinalIgnoreCase) ||
				r.Account.Contains(s, StringComparison.OrdinalIgnoreCase) ||
				r.Type.Contains(s, StringComparison.OrdinalIgnoreCase) ||
				r.Description.Contains(s, StringComparison.OrdinalIgnoreCase));
		}

		_filteredRows = query.ToList();
		ClampPageIndex();
	}

	private void ClampPageIndex()
	{
		if (_filteredRows.Count == 0)
		{
			_pageIndex = 0;
			return;
		}

		var maxIndex = TotalPages - 1;
		if (_pageIndex > maxIndex)
		{
			_pageIndex = maxIndex;
		}
	}

	private static string GetEventClass(string type)
		=> type switch
		{
			"Lỗi" => "is-error",
			"Cảnh Báo" => "is-warn",
			"Hoạt Động Tốt" => "is-ok",
			"Đăng Nhập" => "is-login",
			_ => ""
		};

	private Task ExportExcel()
	{
		// TODO: hook to real export endpoint
		return Task.CompletedTask;
	}

	private sealed record EventTypeOption(string Id, string Name);
	private sealed record HistoryRow(string Id, string Time, string Device, string Account, string Type, string Description);
}
